{%- comment -%}
  Best Sellers Product Card
  
  Accepts:
  - product: Product object
  - index: Position in grid
  - section: Section object for settings
{%- endcomment -%}

{%- liquid
  assign first_variant = product.selected_or_first_available_variant
  assign product_form_id = 'product-form-' | append: section.id | append: '-' | append: product.id
  
  # Check for badge
  assign badge_text = ''
  for block in section.blocks
    if block.type == 'product_badge' and block.settings.product == product
      assign badge_text = block.settings.badge_text
      break
    endif
  endfor
-%}

<div class="best-sellers__card" data-product-id="{{ product.id }}">
  <a href="{{ product.url }}" class="best-sellers__card-image">
    {%- if badge_text != blank -%}
      <span class="best-sellers__badge">{{ badge_text }}</span>
    {%- endif -%}
    
    {%- if product.featured_image != blank -%}
      <img
        src="{{ product.featured_image | image_url: width: 600 }}"
        alt="{{ product.featured_image.alt | escape | default: product.title }}"
        width="{{ product.featured_image.width }}"
        height="{{ product.featured_image.height }}"
        loading="lazy"
      >
    {%- else -%}
      <div class="best-sellers__placeholder-image">
        <span>{{ product.title }}</span>
      </div>
    {%- endif -%}
  </a>
  
  <div class="best-sellers__card-content">
    <a href="{{ product.url }}" class="best-sellers__product-link">
      <h3 class="best-sellers__product-title">{{ product.title }}</h3>
    </a>
    
    {%- if product.metafields.custom.subheading != blank -%}
      <p class="best-sellers__product-desc">{{ product.metafields.custom.subheading }}</p>
    {%- elsif product.metafields.descriptors.subtitle != blank -%}
      <p class="best-sellers__product-desc">{{ product.metafields.descriptors.subtitle.value }}</p>
    {%- elsif product.description != blank -%}
      <p class="best-sellers__product-desc">{{ product.description | strip_html | truncate: 60 }}</p>
    {%- endif -%}
    
    <div class="best-sellers__card-footer">
      {%- if product.variants.size > 1 -%}
        <div class="best-sellers__variant-select">
          <select 
            name="id" 
            form="{{ product_form_id }}"
            data-variant-select
            onchange="updatePrice_{{ section.id }}_{{ product.id }}(this)"
          >
            {%- for variant in product.variants -%}
              <option 
                value="{{ variant.id }}"
                data-price="{{ variant.price | money }}"
                {% if variant == first_variant %}selected{% endif %}
                {% unless variant.available %}disabled{% endunless %}
              >
                {{ variant.title }}{% unless variant.available %} - Sold Out{% endunless %}
              </option>
            {%- endfor -%}
          </select>
        </div>
      {%- else -%}
        <input type="hidden" name="id" value="{{ first_variant.id }}" form="{{ product_form_id }}">
      {%- endif -%}
      
      <span class="best-sellers__price" data-price-{{ section.id }}-{{ product.id }}>
        {{ first_variant.price | money }}
      </span>
    </div>
    
    {%- form 'product', product, id: product_form_id, class: 'best-sellers__form', novalidate: 'novalidate' -%}
      <input type="hidden" name="quantity" value="1">
      {%- if product.variants.size == 1 -%}
        <input type="hidden" name="id" value="{{ first_variant.id }}">
      {%- endif -%}
      
      <button 
        type="submit" 
        name="add" 
        class="best-sellers__add-to-cart"
        {% unless first_variant.available %}disabled{% endunless %}
      >
        {%- if first_variant.available -%}
          ADD TO CART →
        {%- else -%}
          SOLD OUT
        {%- endif -%}
      </button>
    {%- endform -%}
  </div>
</div>

<script>
  function updatePrice_{{ section.id }}_{{ product.id }}(select) {
    const selectedOption = select.options[select.selectedIndex];
    const priceEl = document.querySelector('[data-price-{{ section.id }}-{{ product.id }}]');
    if (priceEl && selectedOption.dataset.price) {
      priceEl.textContent = selectedOption.dataset.price;
    }
    
    // Update form id
    const form = document.getElementById('{{ product_form_id }}');
    if (form) {
      const hiddenInput = form.querySelector('input[name="id"]');
      if (hiddenInput) {
        hiddenInput.value = select.value;
      }
    }
    
    // Update button state
    const button = form ? form.querySelector('.best-sellers__add-to-cart') : null;
    if (button) {
      if (selectedOption.disabled) {
        button.disabled = true;
        button.textContent = 'SOLD OUT';
      } else {
        button.disabled = false;
        button.textContent = 'ADD TO CART →';
      }
    }
  }
</script>
